<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - Kiwi's Bakery</title>
  <link rel="icon" href="{{ url_for('static', filename='images/KiwisLogo.png') }}" type="image/png">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"> 
  <!-- Google Font: Beth Ellen -->
  <link href="https://fonts.googleapis.com/css2?family=Beth+Ellen&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Arial', sans-serif;
    }
    h1, h2 {
      font-family: 'Beth Ellen', cursive;
    }
    .sticky-bar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }
    .sticky-bar h1 {
      font-size: 1.5rem;
      margin: 0 auto;
    }
    .logo-small {
      width: 50px;
      height: auto;
    }
    .cart-image {
      width: 40px;
      height: auto;
    }
    .logo-small {
        width: 50px;
        height: auto;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    .logo-small:hover {
        transform: scale(1.05);
    }
    .custom-submit-btn {
      background-color: #c88860;
      border-color: #c88860;
      color: #fff;
    }
    .custom-submit-btn:hover {
      background-color: #b07754;
      border-color: #b07754;
    }
  </style>
</head>

<body>
  <!-- Sticky Navigation Bar -->
  <div class="sticky-bar">
    <a href="/">
      <img src="{{ url_for('static', filename='images/KiwisLogo.png') }}" alt="Kiwi's Bakery Logo" class="logo-small">
    </a>
    <h1>Kiwi's Bakery</h1>
  </div>

  <!-- Main Content -->
  <div class="container py-5">
    <h2 class="mb-4">Review Your Order</h2>
    <ul id="checkout-cart-list" class="list-group mb-3"></ul>

    <form id="checkout-form">
      <div class="mb-3">
        <input type="text" id="customer-name" class="form-control" placeholder="Your Name" required>
        <div class="invalid-feedback">Please enter your name.</div>
      </div>
      <div class="mb-3">
        <input type="text" id="customer-email" class="form-control" placeholder="Your Email" required>
        <div class="invalid-feedback">Please enter a valid email address.</div>
      </div>
      <div class="mb-3">
        <input type="text" id="customer-phone" class="form-control" placeholder="Your Phone Number" required>
        <div class="invalid-feedback">Please enter a valid phone number.</div>
      </div>
      <button type="submit" class="btn custom-submit-btn" id="submit-btn">
        <span id="submit-text">Submit Order</span>
        <span id="submit-spinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display: none;"></span>
      </button>      
    </form>
  </div>

  <!-- Optional: Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const cart = JSON.parse(localStorage.getItem('cart') || '[]');

  function renderCheckoutCart() {
    const list = document.getElementById('checkout-cart-list');
    list.innerHTML = '';
    cart.forEach(item => {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.textContent = `${item.name} - Qty: ${item.quantity} × $${item.price.toFixed(2)}`;
      list.appendChild(li);
    });
  }

  document.getElementById('checkout-form').onsubmit = function(e) {
    e.preventDefault();

    const btn = document.getElementById('submit-btn');
    const text = document.getElementById('submit-text');
    const spinner = document.getElementById('submit-spinner');

    // Show loading state
    btn.disabled = true;
    text.textContent = 'Processing...';
    spinner.style.display = 'inline-block';

    const nameInput = document.getElementById('customer-name');
    const emailInput = document.getElementById('customer-email');
    const phoneInput = document.getElementById('customer-phone');

    const customerName = nameInput.value.trim();
    const customerEmail = emailInput.value.trim();
    const customerPhone = phoneInput.value.trim();

    const emailRegex = /^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$/;
    const phoneRegex = /^\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/;

    let valid = true;

    // Name presence check
    if (!customerName) {
      nameInput.classList.add('is-invalid');
      valid = false;
    } else {
      nameInput.classList.remove('is-invalid');
    }

    // Email format check
    if (!emailRegex.test(customerEmail)) {
      emailInput.classList.add('is-invalid');
      valid = false;
    } else {
      emailInput.classList.remove('is-invalid');
    }

    // Phone format check
    if (!phoneRegex.test(customerPhone)) {
      phoneInput.classList.add('is-invalid');
      valid = false;
    } else {
      phoneInput.classList.remove('is-invalid');
    }

    if (!valid) {
      btn.disabled = false;
      text.textContent = 'Submit Order';
      spinner.style.display = 'none';
      return;
    }

    console.log("Submitting order...");

    fetch('/submit_order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customer_name: customerName,
        customer_email: customerEmail,
        customer_phone: customerPhone,
        items: cart
      })
    })
    .then(res => {
      if (!res.ok) {
        return res.json().then(data => {
          alert(data.message || "Something went wrong.");
          throw new Error("Validation failed");
        });
      }
      return res.json();
    })
    .then(data => {
      localStorage.removeItem('cart');
      window.location.href = '/orderSubmitted';
    })
    .catch(err => {
      console.error("Submission error:", err);
      btn.disabled = false;
      text.textContent = 'Submit Order';
      spinner.style.display = 'none';
    });
  };

  renderCheckoutCart();
</script>

<footer class="text-center py-4" style="font-size: 0.9rem; color: #666;">
    <p>&copy; {{ current_year }} Kiwi's Bakery – Lakewood, Ohio</p>
    <p>
      <a href="mailto:kiwis.cle@gmail.com" style="color: #666;">Contact Us</a>
      |
      <a href="/privacy" style="color: #666;">Privacy Policy</a>
      |
      <a href="/terms" style="color: #666;">Terms of Service</a>
    </p>
  </footer>
</body>
</html>